{% extends "adminpanel/base.html" %}

{% block title %}Manage Users{% endblock %}

{% block header %}
Manage Users
{% endblock %}

{% block content %}

<!-- Top Buttons -->
<div class="flex justify-end mb-6">
  <a href="{% url 'adminpanel:add_user' %}"
     class="px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition">
    ➕ Add New User
  </a>
</div>

<!-- Search Box -->
<div class="glass p-6 mb-6">
    <input type="text" id="userSearch" onkeyup="filterTable('userSearch', 'userTable')" 
           placeholder="Search Users..." 
           class="w-full p-3 rounded-lg bg-white/10 text-white border border-white/20 focus:outline-none">
</div>

<!-- Users Table -->
<div class="glass p-6 overflow-x-auto rounded-2xl shadow-lg">
  {% if users %}
  <table id="userTable" class="min-w-full text-white">
    <thead>
      <tr class="border-b border-white/10 text-left">
        <th class="py-3 px-4">Username</th>
        <th class="py-3 px-4">Email</th>
        <th class="py-3 px-4">Role</th>
        <th class="py-3 px-4">Created At</th>
        <th class="py-3 px-4 text-center">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for user in users %}
      <tr class="border-b border-white/10 hover:bg-white/10 transition">

        <td class="py-3 px-4">{{ user.username }}</td>
        <td class="py-3 px-4">{{ user.email }}</td>

        <!-- Role -->
        <td class="py-3 px-4">
          {% if user.is_superuser %}
            <span class="px-3 py-1 bg-blue-700 rounded-lg text-sm">Admin</span>
          {% else %}
            <span class="px-3 py-1 bg-blue-500 rounded-lg text-sm">User</span>
          {% endif %}
        </td>

        <td class="py-3 px-4">{{ user.date_joined|date:"M d, Y" }}</td>

        <!-- Actions -->
        <td class="py-3 px-4 text-center">
          <button onclick="openModal('deleteUser{{ user.id }}')" class="btn btn-danger px-3 py-1 rounded-lg">
            Delete
          </button>

            <!-- Delete Modal -->
            <div id="deleteUser{{ user.id }}" class="modal hidden fixed inset-0 bg-black/50 justify-center items-center z-50">
                <div class="glass p-6 rounded-2xl shadow-lg w-96 relative">
                    <button onclick="closeModal('deleteUser{{ user.id }}')" class="absolute top-3 right-3 text-white font-bold">✖</button>
                    <h3 class="text-xl font-bold mb-4">Confirm Delete</h3>
                    <p class="mb-4">Are you sure you want to delete {{ user.username }}?</p>
                    <form method="post" action="{% url 'adminpanel:delete_user' user.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger px-4 py-2 rounded-lg">Yes, Delete</button>
                        <button type="button" onclick="closeModal('deleteUser{{ user.id }}')" class="btn btn-primary px-4 py-2 rounded-lg">Cancel</button>
                    </form>
                </div>
            </div>

        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% else %}
    <p class="text-white text-center py-10">No users found.</p>
  {% endif %}

</div>

<!-- Table Filter Script -->
<script>
function filterTable(inputId, tableId) {
  const input = document.getElementById(inputId);
  const filter = input.value.toLowerCase();
  const table = document.getElementById(tableId);
  const rows = table.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName("td");
      let match = false;
      for (let j = 0; j < cells.length; j++) {
          if (cells[j].textContent.toLowerCase().includes(filter)) {
              match = true;
              break;
          }
      }
      rows[i].style.display = match ? "" : "none";
  }
}

// Modal Functions
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
  document.getElementById(id).classList.add('flex');
}
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
  document.getElementById(id).classList.remove('flex');
}
</script>

{% endblock %}
